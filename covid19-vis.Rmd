---
title: "COVID-19 JHU Visualizations"
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'index.html'))})
author: ""
output:
  rmarkdown::html_document:
    theme: cosmo
    toc: true
date: "Last updated: `r format(Sys.time(), '%d %B, %Y')`"
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F,cache=F)

```
Thanks to JHU for the data used here (https://github.com/CSSEGISandData/COVID-19). Results are only as good as the data, which is only as good as the amount of testing done. 

(Source code: https://github.com/b-lev/covid19-vis)

## Main plot

```{r init, echo=FALSE, include=FALSE}
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(scales))
suppressPackageStartupMessages(library(lubridate))
suppressPackageStartupMessages(library(ggrepel))
suppressPackageStartupMessages(library(data.table))
theme_set(theme_gray(12))
theme_update(legend.position='top')
# read in JHU data
# transpose the colums/rows
# set type column to confirmed" (or deaths or recovered)
# rename columns
confirmed<- fread("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Confirmed.csv") %>% 
	as.tbl %>%
	gather(date, val, -`Province/State`,-`Country/Region`,-Lat ,-Long) %>%
	mutate(date=mdy(date),type='confirmed') %>%
	rename('province'=`Province/State`,region=`Country/Region`)

deaths<- read_csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Deaths.csv") %>% 
	gather(date, val, -`Province/State`,-`Country/Region`,-Lat ,-Long) %>%
	mutate(date=mdy(date),type='deaths') %>%
	rename('province'=`Province/State`,region=`Country/Region`)

recovered<- read_csv('https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Recovered.csv')%>% 
	gather(date, val, -`Province/State`,-`Country/Region`,-Lat ,-Long) %>%
	mutate(date=mdy(date),type='recovered') %>%
	rename('province'=`Province/State`,region=`Country/Region`)

# bind all rows together
covid<- bind_rows(confirmed,deaths,recovered)%>% filter(val>0) %>%
		mutate(region=ifelse(region=='Korea, South',"S.Korea",region))


# cleanup: separate out city and state. 
# Sometimes states are two-letter abbrev; sometimes full name. Make all two letters
US<- filter(covid,region=='US') %>%
	mutate(province=ifelse(str_count(province,",")>0,province,paste0(", ",province))) %>%
	separate(province,c("city",'state'),sep=", ",remove=F,fill="right") %>%
	mutate(state=ifelse(city=="",state.abb[match(state,state.name)],state))%>%
	filter(!is.na(state))

# Grab data fro each state, and ignore cruise ships
US.by_state <- group_by(US,type,date,state)%>% 
	summarize(val=sum(val)) %>%
	filter(!(state  %in% c('CA (From Diamond Princess)','NE (From Diamond Princess)','TX (From Diamond Princess)')))%>%
	group_by(type,state)%>% 
	arrange(type,state,date) %>%
	mutate(delta=val-lag(val)) 


# this is the data from JHU; 
# ma.jhu<-filter(US.by_state,state %in% c('Massachusetts','MA'),val>=1) %>%
# 	mutate(val.log=log(val)) %>%
# 	ungroup %>% 
# 	mutate(rn=row_number())
```

Below is the important plot. We want to be like S. Korea or lower. 


Comparative Growth per captia, where  "day 1" is approx 0.001% of the country's population.


```{r comp-per-cap, fig.width=4,fig.height=3}
# 

comparison<- filter(covid,type %in% c('confirmed'))  %>%
	group_by(region,date,type) %>%
	summarize(val=sum(val)) %>%
	filter(val>=300) %>%
	group_by(region,type) %>%
	mutate(day=row_number())%>%
	filter( region%in% c('Italy','US','S.Korea')) %>%
	mutate(pop=ifelse(region=='Italy',  60462000,
										ifelse(region=='US',  331003000,
													 ifelse(region=='S.Korea',  51269000))))

comp.pc<-comparison %>% filter(val/pop>0.00001) %>%
	group_by(region) %>%
	mutate(day=row_number(),valpc=val/pop)

labels<- comp.pc %>% group_by(region) %>% filter(day==max(day))
# 	mutate(day=max(day,day),valpc=val/pop) 

ggplot(comp.pc)+
	aes(x=day,y=valpc,group=c(region),color=region)+
	theme(legend.position = "none")+
	geom_line()+geom_point()+
	geom_text_repel(data=labels,aes(label=region),color='black',direction='x')+
	scale_y_continuous(breaks=pretty_breaks(10),label=percent)+
	scale_x_continuous(breaks=pretty_breaks(10))+
	labs(y='confirmed cases per capita')
```



## World data

This plot shows the spread of the virus over time across the world. We want the number of confirmed cases (red) to drop to 0, the deaths (green) to stay as low as possible obviously, and the recovered cases (blue) to climb high. 

```{r world, echo=FALSE,fig.width = 5,fig.height=3}

# All three lines for the world
ggplot(covid %>% 
			 	group_by(date,type) %>% 
			 	summarize(val=sum(val)))+
	aes(date,val,group=type,color=type)+
	geom_line()+geom_point()+
	scale_y_continuous(label=comma,breaks=pretty_breaks(),
										 sec.axis = sec_axis(~./7771316390,labels = percent))+
	theme(legend.position = c(.2,.8))+
	scale_x_date(breaks=pretty_breaks())+
	labs(x=element_blank(),y=element_blank(),color=element_blank())
```


### Country breakdown (sometimes without China)

These plots show how the numbers have grown over time in each country for confirmed cases, deaths, and recovered cases. All countries want to hit the bent curve that China has reported achieving. 

```{r country,fig.height=8,fig.width=5}
tmp<- group_by(covid,region,type,date) %>% 
	filter(val>0,region!='China' | type!='recovered',date>='2020-01-20') %>%
	summarize(val=sum(val)) %>%
	group_by(region) %>%
	filter(max(val)>=1)
labels<- group_by(tmp,region,type) %>% filter(date==max(date))  %>%
	ungroup

worst<- c('China',labels %>% 
	group_by(region) %>% 
	summarize(val=max(val)) %>% 
	top_n(8,val) %>% 
	pull(region) )

ggplot(filter(tmp,region %in% worst)
)+theme_gray(12)+
	aes(date,val,group=c(region),color=region)+
	scale_y_continuous(limits = c(NA,NA),
										 breaks=pretty_breaks(8)	)+
	scale_x_date(breaks=pretty_breaks(10),limits = c(min(tmp$date),max(tmp$date)+4))+
	geom_line()+geom_point()+
	theme(legend.position="none")+
	facet_wrap(~type,scales = 'free',ncol=1)+
	theme(legend.position="none",
				axis.text.x = element_text(angle = 90, vjust = .5))+
	labs(x="",y='count')+
	geom_text_repel(data=labels %>%	
										filter(	region %in% worst| region=='US'),
									direction='y',segment.color='dark grey',
									nudge_x =6,
									hjust=0,
									aes(label=region,x=date+3),color='black')
######################
```




### US data

These plots focus on the USA, showing how confirmed, deaths, and recovered have grown over time. Just like above, we want confirmed to come back down to zero, deaths to stay as low as possible, and recovered to grow very high. 

```{r states, fig.height = 6, fig.width=8}

tmp<-group_by(US,state,type,date) %>% 
	summarize(val=sum(val)) %>%
	group_by(state) %>%
	filter(date>'2020-02-23')
labels<- group_by(tmp,type) %>% 
	filter(date==max(date)) %>%
	top_n(5,val)


ggplot(tmp )+
	aes(date,val,group=c(state),color=state)+
	scale_y_continuous(breaks=pretty_breaks(8), limits = c(0,NA),
	)+
	scale_x_date(breaks=pretty_breaks(10),
							 date_labels = "%b%d")+
	geom_line()+geom_point()+
	theme(legend.position="none",
				axis.text.x = element_text(angle = 90, vjust = .5),
				panel.spacing = unit(2, "lines"))+
	geom_text_repel(data=labels,
									direction = 'x',
									aes(label=state,x=date+3),
									color='black')+
	facet_wrap(type~.,nrow=2,scales = 'free')+
	labs(x="",y='')
######################
```

# Predictions for MA, CA, and NY

These plots show the number of confirmed cases in MA, CA, and NY. The red points show the actual reported values. The blue dots and lines show a fit of the data to exponential growth. We want the dots to bend down, and not grow fast like the blue lines. Currently, testing in the US is very, very, very low; as tests given per day increase, we should expect the red dots to grow faster than predicted. If we can get ahead of the virus, the confirmes cases show bend down.

MA data from https://github.com/b-lev/massachusetts-covid19-report-archive. NY and CA from JHU data set.

```{r MA,fig.height=3,fig.width=5}
# this is the data from JHU; see next line
ma.jhu<-filter(US.by_state,state %in% c('Massachusetts','MA'),val>=1) %>%
	mutate(val.log=log(val)) %>%
	ungroup %>% 
	mutate(rn=row_number())

# data scrapped manually from mass.gov. very different than JHU
ma.gov<-suppressMessages(read_csv('MA-stats.csv'))%>%
	mutate(date=mdy(date),
				 val=confirmed+presumptive,
				 val.log=log(val),
				 rn=row_number()-2)%>% 
	mutate(delta=val-lag(val))

# plot new cases per day
# ggplot(ma.gov %>% select(date,val,delta) %>%na.omit)+
# 	aes(date,delta)+
# 	geom_bar(stat="identity")+
# 	scale_y_continuous(breaks=pretty_breaks(10))+
# 	labs(y="new cases in MA per day")

# Fit MA data to exponential 

# adjust "rn>0" to fit to different parts of the data
ma<-select(ma.gov ,date,val,val.log,rn) %>%filter(rn>=10)

lm<-with(ma,lm(val.log~rn))
fit.int<-lm$coefficients[['(Intercept)']]
fit.s<- lm$coefficients[['rn']]
fit<- tibble(rn=1:(25)) %>% 
	mutate(fit=fit.s*rn+fit.int,
				 val=exp(fit),
				 date=as.Date("2020-03-02")+rn) 

# 
# Show fit to line on log-scake
# ggplot()+
# 	geom_point(data=ma.gov ,aes(rn,val.log))+
# 	geom_abline(aes(slope=fit.s,intercept = fit.int),linetype=2)+
# 	geom_line(data=fit,aes(x=rn,y=fit),color='red')+
# 	scale_x_continuous(breaks=pretty_breaks())+
# 	scale_y_continuous(breaks=1:30)+
# 	labs(title=paste(round(fit.s,3),"*x+",round(fit.int,3)))+
# 	labs(y="confirmed (log scale)",x="day")

ggplot()+
	geom_line(data=fit,aes(x=date,y=val,color='prediction'),linetype=2)	+
	geom_point(data=fit,aes(x=date,y=val,color='prediction'))	+
	geom_point(data=ma.gov %>% filter(date>='2020-03-01'),aes(date,val,color='actual'))+
	scale_y_continuous(breaks=pretty_breaks(5),label=comma,
										 sec.axis = dup_axis())+
	scale_x_date(breaks=pretty_breaks(5))+
	theme(legend.position = c(.2,.8))+
	labs(y="confirmed cases in MA",x="",color=element_blank())

```

```{r CA, fig.height=3,fig.width=5}

ca.jhu<-filter(US.by_state,state %in% c('California','CA'),val>=1,date>='2020-03-01') %>%
	mutate(val.log=log(val)) %>%
	ungroup %>% 
	mutate(rn=row_number())%>% 
	filter(type=='confirmed')

lm<-with(ca.jhu,lm(val.log~rn))
fit.int<-lm$coefficients[['(Intercept)']]
fit.s<- lm$coefficients[['rn']]
fit<- tibble(rn=1:(25)) %>% 
	mutate(fit=fit.s*rn+fit.int,
				 val=exp(fit),
				 date=as.Date("2020-02-29")+rn) %>%
	filter(val<=12000000)
# 
# Show fit to line on log-scake
#ggplot()+
#	geom_point(data=ca.jhu,aes(rn,val.log))+
#	geom_abline(aes(slope=fit.s,intercept = fit.int),linetype=2)+
#	geom_line(data=fit,aes(x=rn,y=fit),color='red')+
#	scale_x_continuous(breaks=pretty_breaks())+
#	scale_y_continuous(breaks=1:20,
#										 sec.axis =sec_axis(~ exp(.),name='Continuous scale'))+
#	labs(title=paste(round(fit.s,3),"*x+",round(fit.int,3)))+
#	labs(y="confirmed (log scale)",x="day")

# Show plot and prediction 
ggplot()+
	geom_line(data=fit,aes(x=date,y=val,color='prediction'),linetype=2)	+
	geom_point(data=fit,aes(x=date,y=val,color='prediction'))	+
	geom_point(data=ca.jhu,aes(date,val,color='actual'))+
	scale_y_continuous(breaks=pretty_breaks(),label=comma,
										 sec.axis = dup_axis())+
	scale_x_date(breaks=pretty_breaks(5))+
	theme(legend.position = c(.3,.8))+
	labs(y="confirmed cases in CA",x="",color=element_blank())
```

```{r NY, fig.height=3,fig.width=5}
ny.jhu<-filter(US.by_state,state %in% c('New York','NY'),val>=1,date>'2020-03-07') %>%
	mutate(val.log=log(val)) %>%
	ungroup %>% 
	mutate(rn=row_number())%>% 
	filter(type=='confirmed')

lm<-with(ny.jhu,lm(val.log~rn))
fit.int<-lm$coefficients[['(Intercept)']]
fit.s<- lm$coefficients[['rn']]
fit<- tibble(rn=1:(25)) %>% 
	mutate(fit=fit.s*rn+fit.int,
				 val=exp(fit),
				 date=as.Date("2020-03-07")+rn) %>%
	filter(val<=12000000)
# 
# Show fit to line on log-scake
#ggplot()+
#	geom_point(data=ny.jhu,aes(rn,val.log))+
#	geom_abline(aes(slope=fit.s,intercept = fit.int),linetype=2)+
#	geom_line(data=fit,aes(x=rn,y=fit),color='red')+
#	scale_x_continuous(breaks=pretty_breaks())+
#	scale_y_continuous(breaks=1:20,
#										 sec.axis =sec_axis(~ exp(.),name='Continuous scale'))+
#	labs(title=paste(round(fit.s,3),"*x+",round(fit.int,3)))+
#	labs(y="confirmed (log scale)",x="day")

# Show plot and prediction 
ggplot()+
	geom_line(data=fit,aes(x=date,y=val,color='prediction'),linetype=2)	+
	geom_point(data=fit,aes(x=date,y=val,color='prediction'))	+
	geom_point(data=ny.jhu,aes(date,val,color='actual'))+
	scale_y_continuous(breaks=pretty_breaks(),label=comma,
										 sec.axis = dup_axis())+
	scale_x_date(breaks=pretty_breaks(5))+
	theme(legend.position = c(.3,.8))+
	labs(y="confirmed cases in NY",x="",color=element_blank())

```

# World Fatality Rates

Here is a plot of the fatility rate. It's really hard to tell whether this analysis makes sense given the unreliablity of the data overall. FWIW:

```{r fatality, echo=FALSE}
# fatility date

rate<-  	inner_join(confirmed %>% filter(date==max(date)) %>%  group_by(region) %>% summarize(confirmed=sum(val)),
						 deaths %>%filter(date==max(date)) %>%  group_by(region) %>% summarize(deaths=sum(val)),
						 by = c("region")) %>%
	inner_join(recovered %>%filter(date==max(date)) %>%  group_by(region) %>%	summarize(recovered=sum(val)),
						 by = c("region")) %>%
	filter(region!='Cruise Ship' ) %>%
	mutate(region=ifelse(region=='Korea, South',"S.Korea",region)) %>%
	filter(deaths>0) %>% 
	mutate(rate=deaths/(deaths+confirmed+recovered)) %>%  ungroup %>% 
	rowwise %>%
	mutate(ci=1.96*sqrt(rate*(1-rate)/(deaths+confirmed+recovered))) %>%  ungroup %>% 
	group_by(region) %>% mutate(min_ci=min(ci)) 

ggplot(rate %>% filter(deaths>15))+
	aes(reorder(region,desc(rate)),rate)+
	scale_y_continuous(label=percent,breaks=pretty_breaks(10))+
	geom_bar(stat='identity')+
	geom_text(aes(label=deaths,y=.001),color='dark grey',hjust=0,angle=90)+
	labs(x=element_blank(),y="fatality rate")+
	theme(legend.position="none",
				axis.text.x = element_text(angle = 90, vjust = .0,hjust=1))



```

# Massachusetts-specific Data


MA data from https://github.com/b-lev/massachusetts-covid19-report-archive.


The cumulative fraction of MA covid patients that are hospitalized.

```{r ma-hosp,fig.height=3,fig.width=5}
ma.hosp<-ma.gov %>% select(date,Hospitalized_yes,Hospitalized_no) %>%
	na.omit %>%
	mutate(hosp_frac=Hospitalized_yes/(Hospitalized_yes+Hospitalized_no))

ggplot(ma.hosp)+aes(date,hosp_frac)+
	geom_point()+geom_line()+
	scale_y_continuous(label=percent,limits=c(0,NA),
										 breaks=pretty_breaks(10))+
	labs(y="hospitalization in MA",
			 x=element_blank())
	

```

MA is performing just 300 tests per day, and earlier 200 per day. This plots the number of tests per day; data comes in only once a day...

```{r ma-testing, fig.height=3,fig.width=5}
ma.testing<-select(ma.gov,date,Lab_MA_PHL_pos,
									 Lab_MA_PHL_neg,Lab_LabCorp_pos,
									 Lab_LabCorp_neg,Lab_Quest_pos,
									 Lab_Quest_neg) %>%
	gather(var,val,-date) %>% 
	na.omit %>%
	mutate(result=ifelse(str_ends(var,"_pos"),"pos","neg")) %>%
	group_by(result,date) %>%
	summarize(val=sum(val)) %>%
	filter(val>0) %>%
	mutate(delta=val-lag(val)) %>%
	na.omit

ggplot(ma.testing)+aes(date,delta,group=result,fill=result)+
	geom_bar(stat='identity',position = 'stack',width=1)+
	scale_y_continuous(breaks=pretty_breaks())+
	labs(y="Tests in MA per day")
```


# US Testing Statistics

Testing in each state. Based on https://covidtracking.com/api/states/daily.csv. Sometimes, health care workers are tested, to be sure they are not infected. That is one explanation for why some states show many negatives. 


```{r testing, fig.height=7}

ct<- 
	suppressMessages(read_csv('https://covidtracking.com/api/states/daily.csv'))  %>%
	group_by(state) %>% arrange(state,date) %>%
	mutate(date=ymd(date)) %>%
	mutate(total=positive+negative) %>%
	select(-c(dateChecked))

state.pops<-suppressMessages(read_csv('state-pop-census.csv')) %>%
	mutate(state=state.abb[match(state_name,state.name)]) %>%
	mutate(state=ifelse(state_name=="DC","DC",state)) %>%
	select(state,pop)

testing<-ct %>% group_by(state) %>% arrange(state,date) %>%
	mutate(delta=total-lag(total,1)) %>% 
	inner_join(state.pops,by='state')	%>% ungroup %>%
	mutate(total_per_cap=total/pop)


tmp<- filter(testing,date==max(date))  %>%
	mutate(rate=positive/(positive+negative))
tmp<- mutate(tmp,	 st.f=factor(state,levels =tmp$state[order(tmp$rate)]))

ggplot(tmp)+
	aes(y=st.f,x=rate)+
	geom_bar(stat='identity')+
	scale_x_continuous(label=percent,breaks=pretty_breaks())+
	geom_text(aes(label=positive+negative,x=round(rate+.15,1)),hjust=1)+
	labs(x='COVID testing positive rate  (total tests)',y="State")
```

This plots show how long it is taking each state to test its population, on a per capita basis. 
(I'm assuming, optimistically, that the test had not be given to the same person twice.)

```{r testing2}

## tests per capita
labels=filter(testing,date==max(date)) %>% ungroup %>%
	top_n(n=15,wt=total_per_cap)

ggplot(testing %>% select(date,total_per_cap,state) %>% na.omit)+
	aes(date,total_per_cap,group=state,color=state)+
	geom_line()+
	theme(legend.position = 'none',
								axis.text.x = element_text(angle = 90, vjust = .5))+
	geom_label_repel(data=labels,aes(label=state,x=date+8),
									 nudge_x=1,
									 direction='x')+
	scale_x_date(breaks=pretty_breaks(10))+
	scale_y_continuous(label=percent,breaks=pretty_breaks(10))+
	labs(y="Cumulative perc. of state population tested",x="")


```


I hereby disclaim any and all representations and warranties with respect to this data, including accuracy, fitness for use, and merchantability. Reliance for medical guidance or use in commerce is strictly prohibited.